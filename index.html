<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>D3 Narrative Visualization - Cars 2017</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    svg {
      background-color: #fff;
      border: 1px solid #ccc;
    }

    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      pointer-events: none;
      font-size: 12px;
    }

    .scene-buttons button {
      margin: 5px;
      padding: 5px 10px;
    }

    .annotation {
      font-size: 14px;
      margin-top: 10px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .nav-button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
      border: 1px solid #666;
      display: inline-block;
    }

    .navbar {
      display: flex;
      background-color: #343a40;
      color: white;
      padding: 1px 2px;
      justify-content: flex-start;
      width: 500px;
      gap: 2px;
    }

    .navbar div {
      cursor: pointer;
      padding: 2px 16px;
      border-radius: 5px;
    }

    .navbar div:hover {
      background-color: #495057;
    }

    .navbar .active {
      background-color: #007bff;
    }

    .legend-box {
      font-family: sans-serif;
      font-size: 14px;
    }

    .legend-item {
      margin: 5px;
      display: flex;
      align-items: center;
    }

    .legend-color {
      width: 15px;
      height: 15px;
      margin-right: 5px;
    }
  </style>
</head>

<body>
  <h2>2017 Automobile Data Narrative</h2>
  <div class="scene-buttons">
    <span class="nav-button" id="prev">◀ Back</span>
    <span class="nav-button" id="next">Next ▶</span>
  </div>
  <div class="annotation"></div>
  <svg width="1100" height="700">
  </svg>
  <div class="tooltip" style="opacity: 0;"></div>
  <script>
    const svg = d3.select("svg"),
      margin = {
        top: 50,
        right: 50,
        bottom: 50,
        left: 70
      },
      width = +svg.attr("width") - margin.left - margin.right - 300,
      height = +svg.attr("height") - margin.top - margin.bottom - 100,
      g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const scenes = [{
        id: 0,
        title: "All Cars",
        filter: d => true
      },
      {
        id: 1,
        title: "Electric Cars",
        filter: d => d.Fuel === "Electricity"
      },
      {
        id: 2,
        title: "Gasoline Cars",
        filter: d => d.Fuel === "Gasoline"
      },
      {
        id: 3,
        title: "Diesel Cars",
        filter: d => d.Fuel === "Diesel"
      },
    ];

    let current = 0;
    const slides = d3.select("#slides");

    const tooltip = d3.select(".tooltip");
    const annotation = d3.select(".annotation");

    let x = d3.scaleLog().range([0, width]).base(10);
    let y = d3.scaleLog().range([height, 0]).base(10);
    let radius = d3.scaleLinear().range([3, 10]);

    let color = d3.scaleOrdinal(d3.schemeCategory10);
    let data;

    // Load CSV
    d3.csv("https://flunky.github.io/cars2017.csv").then(raw => {
      data_backup = raw.filter(d => d.AverageCityMPG > 0 && d.AverageHighwayMPG > 0);
      data = raw.filter(d => d.AverageCityMPG > 0 && d.AverageHighwayMPG > 0);

      data.forEach(d => {

        d.AverageCityMPG = +d.AverageCityMPG;
        d.AverageHighwayMPG = +d.AverageHighwayMPG;
        d.EngineCylinders = +d.EngineCylinders;
      });

      x.domain(d3.extent(data, d => d.AverageCityMPG));
      y.domain(d3.extent(data, d => d.AverageHighwayMPG));
      radius.domain(d3.extent(data, d => d.EngineCylinders));

      // Axes
      g.append("g")
        .attr("class", "x-axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x)
          .tickValues([10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 150])
          .ticks(10, "~s"));

      g.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(y)
          .tickValues([20, 30, 40, 50, 60, 70, 80, 90, 100, 120])
          .ticks(10, "~s"));

      g.append("text")
        .attr("x", width / 2)
        .attr("y", height + 35)
        .attr("text-anchor", "middle")
        .text("Average City MPG (log scale)");

      g.append("text")
        .attr("x", -height / 2)
        .attr("y", -50)
        .attr("transform", "rotate(-90)")
        .attr("text-anchor", "middle")
        .text("Average Highway MPG (log scale)");

      svg.append("foreignObject")
        .attr("width", 500)
        .attr("height", 100)
        .attr("transform", `translate(100,${height + 100})`)
        .append("xhtml:div") // Use xhtml:div for HTML content within foreignObject
        .style("background-color", "lightblue")
        .html(`
            <div class="navbar">
              <div id="nav0" class="active" onclick="showScene(0)">All Cars</div>
              <div id="nav1" onclick="showScene(1)">Electric Cars</div>
              <div id="nav2" onclick="showScene(2)">Gasoline Cars</div>
              <div id="nav3" onclick="showScene(3)">Diesel Cars</div>
            </div>
	          `);

      svg.append("foreignObject")
        .attr("width", 500)
        .attr("height", 100)
        .attr("transform", `translate(100,${height + 150})`)
        .append("xhtml:div") // Use xhtml:div for HTML content within foreignObject
        // .style("background-color", "lightblue")
        .html(`
            <div class="cyloption">
              <label for="EngineCylinders">Choose number of EngineCylinders:</label>
              <select id="comparison" onchange="changeComp()">
                <option value="equal">Equal to</option>
                <option value="less">Less than</option>
                <option value="greater">Greater than</option>
              </select>
              <select id="EngineCylinders" onchange="changeOption()">
                <option id="ALL" value="ALL">All</option>
                <option id="0" value="0">0</option>
                <option id="2" value="2">2</option>
                <option id="3" value="3">3</option>
                <option id="4" value="4">4</option>
                <option id="6" value="6">6</option>
                <option id="8" value="8">8</option>
                <option id="10" value="10">10</option>
               
              </select>
            </div>
          `);

      svg.append("foreignObject")
        .attr("width", 500)
        .attr("height", 100)
        .attr("transform", `translate(${width+150},${height - 350})`)
        .append("xhtml:div") // Use xhtml:div for HTML content within foreignObject
        // .style("background-color", "lightblue")
        .html(`
            <div id="legend" class="legend-box"></div>
          `);

      const legendData = [{
          label: "Gasoline",
          color: "purple"
        },
        {
          label: "Electricity",
          color: "blue"
        },
        {
          label: "Diesel",
          color: "green"
        }
      ];


      const legend = d3.select("#legend")
        .selectAll("div")
        .data(legendData)
        .enter()
        .append("div")
        .attr("class", "legend-item");

      legend.append("div")
        .attr("class", "legend-color")
        .style("background-color", d => d.color);

      legend.append("span")
        .text(d => d.label);

      showScene(0);
    });

    function getHighlightColor(carType) {
      switch (carType) {
        case "Electricity":
          return "blue"
          break;
        case "Gasoline":
          return "purple"
          break;
        case "Diesel":
          return "green"
          break;

      }

    }

    function updateChart(filterFn, highlightColor, note, carType) {
      svg.selectAll(".annotation-group").remove();
      selValue = d3.select("#EngineCylinders").property("value");
      selComp = d3.select("#comparison").property("value");
      //filter data
      if (selValue == 'ALL') {
        fn2 = d => true
      } else {
        if (selComp == 'equal') {
          fn2 = d => d.EngineCylinders == Number(selValue)
        }
        if (selComp == 'less') {
          fn2 = d => d.EngineCylinders < Number(selValue)
        }
        if (selComp == 'greater') {
          fn2 = d => d.EngineCylinders > Number(selValue)
        }

      }

      data_annot = data.filter(filterFn).filter(fn2);
      maxCity = d3.max(data_annot, d => d.AverageCityMPG);
      highways = data_annot.filter(d => d.AverageCityMPG === maxCity);
      maxHighway = highways[0]?.AverageHighwayMPG;
      annotMake = highways[0]?.Make;
      annotCylinder = highways[0]?.EngineCylinders;
      annotId = annotMake + annotCylinder + maxCity + maxHighway;
      console.log("annotId ----" + annotId)
      const circles = g.selectAll("circle").data(data);
      circles.exit().remove();
      const enter = circles.enter().append("circle")
        .attr("cx", d => x(d.AverageCityMPG))
        .attr("cy", d => y(d.AverageHighwayMPG))
        //.attr("r", d => (d.Make + d.EngineCylinders + d.AverageCityMPG + d.AverageHighwayMPG === annotId) ? (radius(d.EngineCylinders) || 4) + 40 : (radius(d.EngineCylinders) || 4))
        .attr("r", d => (radius(d.EngineCylinders) || 4))
        .attr("opacity", 0.7)
        .on("mouseover", function(d) {
          d3.select(this).attr("stroke", "#000").attr("stroke-width", 1.2);
          tooltip.style("opacity", 1)
            .html(`<strong>${d.Make}</strong><br>Fuel: ${d.Fuel}<br>Cylinders: ${d.EngineCylinders}<br>City MPG: ${d.AverageCityMPG}<br>Highway MPG: ${d.AverageHighwayMPG}`)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
          d3.select(this).attr("stroke", null);
          tooltip.style("opacity", 0);
          showScene(current)
        });

      enter.merge(circles)
        .transition().duration(100)
        .attr("id", d => d.Make + d.EngineCylinders + d.AverageCityMPG + d.AverageHighwayMPG)
        .attr("class", d => d.Make + "-" + d.EngineCylinders + "-" + d.AverageCityMPG + "-" + d.AverageHighwayMPG)
        .attr("visibility", d => fn2(d) ? "visible" : "hidden")
        // .attr("fill", d => filterFn(d) ? (d.Make + d.EngineCylinders + d.AverageCityMPG + d.AverageHighwayMPG === annotId) ? "black" : getHighlightColor(d.Fuel) : "#ccc")
        .attr("fill", d => filterFn(d) ? getHighlightColor(d.Fuel) : "#ccc")
        .attr("stroke-width", d => (d.Make + d.EngineCylinders + d.AverageCityMPG + d.AverageHighwayMPG === annotId) ? 3 : 0)
        .style("stroke", d => (d.Make + d.EngineCylinders + d.AverageCityMPG + d.AverageHighwayMPG === annotId) ? "red" : "none")
        .attr("opacity", d => filterFn(d) ? 0.9 : 0.3);

      annotation.text(note);



      myArr = {
        "equal": "equal to ",
        "less": "less than ",
        "greater": "greater than "
      };

      text1 = (selValue == 'ALL') ? "" : " which has number of cylinders " + myArr[selComp] + selValue;

      if ((maxCity !== undefined) & (maxHighway !== undefined)) {

        svg.append("text")
          .attr("class", "annotation-group")
          .attr("x", x(maxCity))
          .attr("y", y(maxHighway) + 35)
          .text("Highest city MPG of " + carType + " cars " + text1)
          .attr("font-size", "12px")
          .attr("fill", "black");
      }
    }

    function showScene(sceneNum) {
      console.log('nav' + sceneNum)
      switch (sceneNum) {
        case 0:
          updateChart(() => true, "grey", "Scene 1: Overview of all type cars. Hover for details.", "All type of");
          setActiveButton(sceneNum)
          break;
        case 1:
          updateChart(d => d.Fuel === "Electricity", "blue", "Scene 2: Highlighting electric cars.", "Electricity");
          setActiveButton(sceneNum)
          break;
        case 2:
          updateChart(d => d.Fuel === "Gasoline", "red", "Scene 3: Highlighting Gasoline cars.", "Gasoline");
          setActiveButton(sceneNum)
          break;
        case 3:

          updateChart(d => d.Fuel === "Diesel", "green", "Scene 4: Highlighting Diesel cars.", "Diesel");
          setActiveButton(sceneNum)

          break;
      }
    }

    d3.select("#next").on("click", () => {
      current = Math.min(scenes.length - 1, current + 1);
      showScene(current)
    });
    d3.select("#prev").on("click", () => {
      current = Math.max(0, current - 1);
      showScene(current)
    });

    function changeOption() {
      showScene(current)
    }

    function changeComp() {

      selValue = d3.select("#EngineCylinders").property("value");
      selComp = d3.select("#comparison").property("value");
      //     console.log("equal equal equal" + selComp)
      d3.select("#ALL").property("disabled", false);
      if (selComp == 'less') {
        d3.select("#ALL").property("disabled", true);
        d3.select("#EngineCylinders").property("value", selValue == 'ALL' ? 12 : selValue)
      }

      if (selComp == 'greater') {
        d3.select("#ALL").property("disabled", true);
        d3.select("#EngineCylinders").property("value", selValue == 'ALL' ? 0 : selValue)
      }
      showScene(current)
    }

    function setActiveButton(activeId) {
      current = activeId;
      activeId = 'nav' + activeId;
      d3.select(".navbar").selectAll("div").each(function(d, i, nodes) {
        console.log(this.id)
        d3.select(this).attr("class", this.id === activeId ? "active" : "");
      });
    }
  </script>
</body>

</html>
